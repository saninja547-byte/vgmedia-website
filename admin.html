<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω b√†i h√°t - VGMEDIA</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Th√™m styles cho upload section */
        .upload-section {
            background: var(--dark-lighter);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed var(--primary);
        }
        
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: var(--radius-md);
            padding: 40px;
            text-align: center;
            background: rgba(108, 99, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background: rgba(108, 99, 255, 0.1);
            border-color: var(--secondary);
        }
        
        .upload-progress {
            display: none;
            margin-top: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: var(--radius-md);
            padding: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #6C63FF, #FF6584);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .upload-preview {
            display: none;
            margin-top: 20px;
            background: rgba(108, 99, 255, 0.1);
            border-radius: var(--radius-md);
            padding: 20px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .file-info i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .upload-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-upload {
            padding: 10px 20px;
            background: linear-gradient(135deg, #6C63FF, #FF6584);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-upload:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .admin-tabs {
            display: flex;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }
        
        .admin-tab {
            padding: 15px 30px;
            background: none;
            border: none;
            color: var(--gray-light);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .admin-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .admin-content-section {
            display: none;
        }
        
        .admin-content-section.active {
            display: block;
        }
        
        .storage-info {
            background: rgba(108, 99, 255, 0.1);
            padding: 15px;
            border-radius: var(--radius-md);
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--gray-light);
        }
        
        .storage-info.warning {
            background: rgba(255, 101, 132, 0.1);
            color: #FF6584;
        }
        
        .warning-icon {
            color: #FF6584;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="admin-logo">
                <h2>VG<span>MEDIA</span> Admin</h2>
                <p>Qu·∫£n l√Ω n·ªôi dung</p>
            </div>
            
            <nav class="admin-nav">
                <a href="#songs" class="admin-nav-link active" data-tab="songs">
                    <i class="fas fa-music"></i> Qu·∫£n l√Ω b√†i h√°t
                </a>
                <a href="#upload" class="admin-nav-link" data-tab="upload">
                    <i class="fas fa-upload"></i> Upload nh·∫°c
                </a>
                <a href="./index.html" class="admin-nav-link">
                    <i class="fas fa-home"></i> V·ªÅ trang ch·ªß
                </a>
            </nav>
            
            <div class="admin-user">
                <span id="adminUsername">Qu·∫£n tr·ªã vi√™n</span>
                <button id="adminLogout" title="ƒêƒÉng xu·∫•t">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="admin-main">
            <header class="admin-header">
                <h1><i class="fas fa-cog"></i> Tr√¨nh qu·∫£n l√Ω VGMEDIA</h1>
                <div class="admin-actions">
                    <button class="btn-admin btn-add-song" id="addSongBtn">
                        <i class="fas fa-plus"></i> Th√™m b√†i h√°t
                    </button>
                </div>
            </header>
            
            <!-- Tabs -->
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="songs">Danh s√°ch b√†i h√°t</button>
                <button class="admin-tab" data-tab="upload">Upload nh·∫°c</button>
                <button class="admin-tab" data-tab="storage">Qu·∫£n l√Ω b·ªô nh·ªõ</button>
            </div>
            
            <!-- Songs Management Section -->
            <div id="songsSection" class="admin-content-section active">
                <div class="admin-content">
                    <!-- Search and Filter -->
                    <div class="admin-toolbar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchSongs" placeholder="T√¨m ki·∫øm b√†i h√°t...">
                        </div>
                        
                        <div class="filter-options">
                            <select id="filterType">
                                <option value="all">T·∫•t c·∫£ b√†i h√°t</option>
                                <option value="premium">Premium</option>
                                <option value="free">Mi·ªÖn ph√≠</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Songs Table -->
                    <div class="admin-table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>B√†i h√°t</th>
                                    <th>Ngh·ªá sƒ©</th>
                                    <th>Th·ªÉ lo·∫°i</th>
                                    <th>Lo·∫°i</th>
                                    <th>Gi√° (VND)</th>
                                    <th>Th·ªùi l∆∞·ª£ng</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="songsTableBody">
                                <!-- Data loaded by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Upload Section -->
            <div id="uploadSection" class="admin-content-section">
                <div class="admin-content">
                    <div class="upload-section">
                        <h3><i class="fas fa-cloud-upload-alt"></i> Upload nh·∫°c t·ª´ m√°y t√≠nh</h3>
                        <p>H·ªó tr·ª£ file MP3, WAV, OGG, FLAC, M4A, AAC (t·ªëi ƒëa 500MB)</p>
                        
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #6C63FF; margin-bottom: 15px;"></i>
                            <h4>K√©o th·∫£ file nh·∫°c v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h4>
                            <p>File s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o b·ªô nh·ªõ tr√¨nh duy·ªát</p>
                            <input type="file" id="fileInput" accept="audio/*,.mp3,.wav,.ogg,.flac,.m4a,.aac" style="display: none;">
                        </div>
                        
                        <!-- Upload Progress -->
                        <div class="upload-progress" id="uploadProgress">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span id="progressText">ƒêang x·ª≠ l√Ω...</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>
                        
                        <!-- Upload Preview -->
                        <div class="upload-preview" id="uploadPreview">
                            <div class="file-info">
                                <i class="fas fa-file-audio"></i>
                                <div>
                                    <div style="font-weight: bold; color: white;" id="fileName">--</div>
                                    <div style="color: #8A8A8A; font-size: 0.9rem;" id="fileDetails">--</div>
                                </div>
                            </div>
                            
                            <div id="metadataPreview" style="margin-top: 15px; display: none;">
                                <h5 style="margin-bottom: 10px; color: var(--primary);">
                                    <i class="fas fa-info-circle"></i> Th√¥ng tin ph√°t hi·ªán t·ª± ƒë·ªông
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div>
                                        <label>T√™n b√†i h√°t:</label>
                                        <input type="text" id="autoTitle" class="form-control" placeholder="T·ª± ƒë·ªông nh·∫≠n di·ªán">
                                    </div>
                                    <div>
                                        <label>Th·ªùi l∆∞·ª£ng:</label>
                                        <input type="text" id="autoDuration" class="form-control" placeholder="T·ª± ƒë·ªông nh·∫≠n di·ªán">
                                    </div>
                                    <div>
                                        <label>Th·ªÉ lo·∫°i:</label>
                                        <input type="text" id="autoGenre" class="form-control" placeholder="EDM">
                                    </div>
                                    <div>
                                        <label>BPM:</label>
                                        <input type="text" id="autoBPM" class="form-control" placeholder="128 BPM">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="upload-actions">
                                <button class="btn-upload" id="processMetadataBtn">
                                    <i class="fas fa-magic"></i> Ph√¢n t√≠ch metadata
                                </button>
                                <button class="btn-upload" id="addToLibraryBtn" style="background: #4CAF50;">
                                    <i class="fas fa-plus"></i> Th√™m v√†o th∆∞ vi·ªán
                                </button>
                                <button class="btn-upload" id="cancelUploadBtn" style="background: var(--dark-lighter); color: var(--gray-light);">
                                    <i class="fas fa-times"></i> H·ªßy
                                </button>
                            </div>
                        </div>
                        
                        <!-- Storage Warning -->
                        <div class="storage-info warning" id="storageWarning" style="display: none;">
                            <i class="fas fa-exclamation-triangle warning-icon"></i>
                            <strong>Ch√∫ √Ω:</strong> B·ªô nh·ªõ tr√¨nh duy·ªát c√≥ th·ªÉ b·ªã ƒë·∫ßy khi upload nhi·ªÅu file l·ªõn. 
                            Vui l√≤ng x√≥a b·ªõt file c≈© trong m·ª•c "Qu·∫£n l√Ω b·ªô nh·ªõ".
                        </div>
                    </div>
                    
                    <!-- Recently Uploaded -->
                    <div style="margin-top: 30px;">
                        <h4><i class="fas fa-history"></i> File ƒë√£ upload g·∫ßn ƒë√¢y</h4>
                        <div id="recentUploads" style="
                            background: var(--dark-lighter);
                            border-radius: var(--radius-md);
                            padding: 20px;
                            margin-top: 15px;
                            max-height: 300px;
                            overflow-y: auto;
                        ">
                            <!-- Recent uploads will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Storage Management Section -->
            <div id="storageSection" class="admin-content-section">
                <div class="admin-content">
                    <h3><i class="fas fa-database"></i> Qu·∫£n l√Ω b·ªô nh·ªõ</h3>
                    <p>Theo d√µi v√† qu·∫£n l√Ω b·ªô nh·ªõ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi VGMEDIA</p>
                    
                    <div class="storage-info">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>B·ªô nh·ªõ ƒë√£ s·ª≠ d·ª•ng:</span>
                            <span id="storageUsed">0 MB</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span>S·ªë l∆∞·ª£ng file:</span>
                            <span id="fileCount">0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="storageProgress" style="background: #6C63FF;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4><i class="fas fa-trash"></i> D·ªçn d·∫πp b·ªô nh·ªõ</h4>
                        <div style="background: rgba(255, 101, 132, 0.1); padding: 20px; border-radius: var(--radius-md); margin-top: 15px;">
                            <p style="color: #FF6584; margin-bottom: 15px;">
                                <i class="fas fa-exclamation-circle"></i>
                                <strong>Ch√∫ √Ω:</strong> X√≥a file s·∫Ω x√≥a vƒ©nh vi·ªÖn kh·ªèi h·ªá th·ªëng
                            </p>
                            
                            <div id="storageFiles" style="margin-bottom: 20px;">
                                <!-- List of storage files will be shown here -->
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-upload" id="cleanOldFilesBtn" style="background: #FF9800;">
                                    <i class="fas fa-broom"></i> X√≥a file c≈© (7+ ng√†y)
                                </button>
                                <button class="btn-upload" id="cleanAllFilesBtn" style="background: #FF6584;">
                                    <i class="fas fa-trash-alt"></i> X√≥a t·∫•t c·∫£ file upload
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Edit Modal -->
            <div id="editModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-edit"></i> <span id="modalTitle">Ch·ªânh s·ª≠a b√†i h√°t</span></h3>
                        <span class="modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="editSongForm">
                            <input type="hidden" id="editSongId">
                            
                            <div class="form-group">
                                <label for="editTitle">T√™n b√†i h√°t *</label>
                                <input type="text" id="editTitle" required placeholder="Nh·∫≠p t√™n b√†i h√°t">
                                <small class="form-text">T·ª± ƒë·ªông nh·∫≠n di·ªán t·ª´ t√™n file</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="editArtist">Ngh·ªá sƒ© *</label>
                                <input type="text" id="editArtist" required placeholder="Nh·∫≠p t√™n ngh·ªá sƒ©">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editGenre">Th·ªÉ lo·∫°i *</label>
                                    <input type="text" id="editGenre" required placeholder="EDM, Pop, Hip Hop...">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editBPM">BPM (Nh·ªãp)</label>
                                    <input type="text" id="editBPM" placeholder="128 BPM">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editDuration">Th·ªùi l∆∞·ª£ng (HH:MM:SS) *</label>
                                    <input type="text" id="editDuration" placeholder="3:30" required>
                                    <small class="form-text">T·ª± ƒë·ªông nh·∫≠n di·ªán t·ª´ file</small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editType">Lo·∫°i b√†i h√°t *</label>
                                    <select id="editType">
                                        <option value="free">Mi·ªÖn ph√≠</option>
                                        <option value="premium">Premium</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="editPrice">Gi√° (VND)</label>
                                    <input type="number" id="editPrice" min="0" value="199000">
                                    <small class="form-text">0 VND cho b√†i h√°t mi·ªÖn ph√≠</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="editAudioFile">URL file nh·∫°c *</label>
                                <input type="text" id="editAudioFile" placeholder="local:file_key_or_external_url" required>
                                <small class="form-text">S·ª≠ d·ª•ng "local:" cho file upload ho·∫∑c URL b√™n ngo√†i</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="editThumbnail">·∫¢nh thumbnail (URL)</label>
                                <input type="text" id="editThumbnail" placeholder="https://images.unsplash.com/photo-...">
                                <small class="form-text">T·ª± ƒë·ªông ch·ªçn ·∫£nh m·∫∑c ƒë·ªãnh</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="editDescription">M√¥ t·∫£</label>
                                <textarea id="editDescription" rows="3" placeholder="M√¥ t·∫£ b√†i h√°t..."></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn-admin btn-cancel">H·ªßy</button>
                                <button type="submit" class="btn-admin btn-save">
                                    <i class="fas fa-save"></i> L∆∞u b√†i h√°t
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Load scripts -->
    <script src="./js/music-data.js"></script>
    <script src="./js/auth-fixed.js"></script>
    <script src="./js/audio-metadata.js"></script>
    <script src="./js/file-upload-enhanced.js"></script>
    <script src="./js/admin-fixed.js"></script>
    
    <script>
        // Admin Upload Script
        console.log('üéµ Admin Upload System Loaded');
        
        document.addEventListener('DOMContentLoaded', function() {
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p admin
            const user = getCurrentUser();
            if (!user || user.type !== 'admin') {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n Admin!');
                window.location.href = './login.html';
                return;
            }
            
            initAdminUpload();
            initStorageManagement();
            setupAdminTabs();
            updateStorageInfo();
            loadRecentUploads();
        });
        
        function initAdminUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadPreview = document.getElementById('uploadPreview');
            const processMetadataBtn = document.getElementById('processMetadataBtn');
            const addToLibraryBtn = document.getElementById('addToLibraryBtn');
            const cancelUploadBtn = document.getElementById('cancelUploadBtn');
            
            let currentFile = null;
            let currentMetadata = null;
            
            // Click upload area
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#FF6584';
                uploadArea.style.background = 'rgba(108, 99, 255, 0.1)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#6C63FF';
                uploadArea.style.background = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#6C63FF';
                uploadArea.style.background = '';
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
            
            // Handle file selection
            async function handleFileSelect(file) {
                if (!file) return;
                
                currentFile = file;
                
                // Show file info
                document.getElementById('fileName').textContent = file.name;
                const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                document.getElementById('fileDetails').textContent = 
                    `${file.type || 'audio/mpeg'} ‚Ä¢ ${fileSize} MB`;
                
                // Show preview and progress
                uploadPreview.style.display = 'block';
                uploadProgress.style.display = 'block';
                
                // Hide metadata preview initially
                document.getElementById('metadataPreview').style.display = 'none';
                
                // Reset buttons
                processMetadataBtn.disabled = false;
                addToLibraryBtn.disabled = true;
                addToLibraryBtn.innerHTML = '<i class="fas fa-plus"></i> Th√™m v√†o th∆∞ vi·ªán';
                
                // Auto process metadata after a delay
                setTimeout(() => {
                    processMetadata();
                }, 500);
            }
            
            // Process metadata button
            processMetadataBtn.addEventListener('click', processMetadata);
            
            async function processMetadata() {
                if (!currentFile) return;
                
                processMetadataBtn.disabled = true;
                processMetadataBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch...';
                
                try {
                    // Use audio metadata extractor
                    if (window.AudioMetadataExtractor) {
                        const extractor = new AudioMetadataExtractor();
                        currentMetadata = await extractor.getBasicInfo(URL.createObjectURL(currentFile));
                        
                        // Update form with metadata
                        document.getElementById('autoTitle').value = extractor.extractTitleFromFileName(currentFile.name);
                        document.getElementById('autoDuration').value = currentMetadata.duration;
                        document.getElementById('autoGenre').value = extractor.guessGenre(currentFile.name);
                        document.getElementById('autoBPM').value = extractor.guessBPM(document.getElementById('autoGenre').value);
                        
                        // Show metadata preview
                        document.getElementById('metadataPreview').style.display = 'block';
                        
                        // Enable add to library button
                        addToLibraryBtn.disabled = false;
                        
                        showNotification('‚úÖ ƒê√£ ph√¢n t√≠ch metadata th√†nh c√¥ng!', 'success');
                    }
                } catch (error) {
                    console.error('Metadata extraction error:', error);
                    showNotification('‚ö†Ô∏è Kh√¥ng th·ªÉ ph√¢n t√≠ch metadata, vui l√≤ng nh·∫≠p th·ªß c√¥ng', 'warning');
                    
                    // Still enable add to library
                    addToLibraryBtn.disabled = false;
                } finally {
                    processMetadataBtn.innerHTML = '<i class="fas fa-magic"></i> Ph√¢n t√≠ch l·∫°i metadata';
                    processMetadataBtn.disabled = false;
                }
            }
            
            // Add to library button
            addToLibraryBtn.addEventListener('click', async () => {
                if (!currentFile) return;
                
                addToLibraryBtn.disabled = true;
                addToLibraryBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                
                try {
                    // Upload file to storage
                    const uploader = new FileUploaderEnhanced();
                    
                    // Show upload progress
                    uploadProgress.style.display = 'block';
                    updateProgress(0, 'ƒêang chu·∫©n b·ªã upload...');
                    
                    // Upload file
                    const result = await uploadFileWithProgress(currentFile, uploader);
                    
                    if (result.success) {
                        updateProgress(100, 'Upload th√†nh c√¥ng!');
                        
                        // Add to music library
                        const songs = JSON.parse(localStorage.getItem('vgmedia_music_library') || '[]');
                        const newId = songs.length > 0 ? Math.max(...songs.map(s => s.id)) + 1 : 1;
                        
                        const title = document.getElementById('autoTitle').value || 
                                    uploader.extractTitleFromFileName(currentFile.name);
                        const duration = document.getElementById('autoDuration').value || 
                                       result.metadata?.duration || '0:00';
                        const genre = document.getElementById('autoGenre').value || 'EDM';
                        const bpm = document.getElementById('autoBPM').value || '128 BPM';
                        
                        const newSong = {
                            id: newId,
                            title: title,
                            artist: 'Ngh·ªá sƒ© ch∆∞a x√°c ƒë·ªãnh',
                            duration: duration,
                            genre: genre,
                            bpm: bpm,
                            price: 0, // Default free
                            type: 'free',
                            thumbnail: 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?auto=format&fit=crop&w=500&q=80',
                            audioUrl: `local:${result.storageKey}`,
                            description: 'B√†i h√°t ƒë∆∞·ª£c upload t·ª´ Admin',
                            fileSize: uploader.formatFileSize(currentFile.size),
                            uploadedBy: getCurrentUser().username,
                            uploadedAt: new Date().toISOString()
                        };
                        
                        songs.push(newSong);
                        localStorage.setItem('vgmedia_music_library', JSON.stringify(songs));
                        
                        showNotification(`‚úÖ ƒê√£ th√™m "${title}" v√†o th∆∞ vi·ªán!`, 'success');
                        
                        // Reset form
                        setTimeout(() => {
                            resetUploadForm();
                            loadRecentUploads();
                            updateStorageInfo();
                            
                            // Switch to songs tab
                            document.querySelector('.admin-tab[data-tab="songs"]').click();
                            
                            // Reload songs table
                            if (window.loadSongsTable) {
                                window.loadSongsTable();
                            }
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Add to library error:', error);
                    showNotification(`‚ùå L·ªói: ${error.message}`, 'error');
                    addToLibraryBtn.disabled = false;
                    addToLibraryBtn.innerHTML = '<i class="fas fa-plus"></i> Th·ª≠ l·∫°i';
                }
            });
            
            // Cancel upload button
            cancelUploadBtn.addEventListener('click', resetUploadForm);
            
            // Upload file with progress
            async function uploadFileWithProgress(file, uploader) {
                return new Promise((resolve, reject) => {
                    // Simulate progress (in real app, this would be actual upload progress)
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 10;
                        updateProgress(progress, `ƒêang upload: ${progress}%`);
                        
                        if (progress >= 90) {
                            clearInterval(interval);
                            
                            // Actually upload the file
                            uploader.uploadFileToLocalStorage(file)
                                .then(async (result) => {
                                    updateProgress(100, 'ƒêang x·ª≠ l√Ω metadata...');
                                    
                                    // Get metadata
                                    const metadata = await uploader.getAudioMetadata(file);
                                    
                                    resolve({
                                        success: true,
                                        storageKey: result.storageKey,
                                        metadata: metadata
                                    });
                                })
                                .catch(reject);
                        }
                    }, 200);
                });
            }
            
            // Update progress
            function updateProgress(percent, text) {
                document.getElementById('progressFill').style.width = percent + '%';
                document.getElementById('progressPercent').textContent = percent + '%';
                document.getElementById('progressText').textContent = text;
            }
            
            // Reset upload form
            function resetUploadForm() {
                currentFile = null;
                currentMetadata = null;
                
                // Reset UI
                uploadPreview.style.display = 'none';
                uploadProgress.style.display = 'none';
                document.getElementById('metadataPreview').style.display = 'none';
                document.getElementById('fileInput').value = '';
                
                // Reset buttons
                processMetadataBtn.disabled = false;
                processMetadataBtn.innerHTML = '<i class="fas fa-magic"></i> Ph√¢n t√≠ch metadata';
                addToLibraryBtn.disabled = true;
                addToLibraryBtn.innerHTML = '<i class="fas fa-plus"></i> Th√™m v√†o th∆∞ vi·ªán';
                
                // Clear form
                document.getElementById('autoTitle').value = '';
                document.getElementById('autoDuration').value = '';
                document.getElementById('autoGenre').value = '';
                document.getElementById('autoBPM').value = '';
            }
        }
        
        function initStorageManagement() {
            // Clean old files button
            document.getElementById('cleanOldFilesBtn')?.addEventListener('click', cleanOldFiles);
            
            // Clean all files button
            document.getElementById('cleanAllFilesBtn')?.addEventListener('click', cleanAllFiles);
            
            // Load storage files list
            loadStorageFiles();
        }
        
        function setupAdminTabs() {
            const tabs = document.querySelectorAll('.admin-tab');
            const navLinks = document.querySelectorAll('.admin-nav-link');
            
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update active section
                    document.querySelectorAll('.admin-content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(tabId + 'Section').classList.add('active');
                    
                    // Update nav link
                    navLinks.forEach(link => {
                        if (link.dataset.tab === tabId) {
                            link.classList.add('active');
                        } else {
                            link.classList.remove('active');
                        }
                    });
                    
                    // Update storage info when switching to storage tab
                    if (tabId === 'storage') {
                        updateStorageInfo();
                        loadStorageFiles();
                    }
                    
                    // Update recent uploads when switching to upload tab
                    if (tabId === 'upload') {
                        loadRecentUploads();
                        updateStorageInfo();
                    }
                });
            });
            
            // Nav link switching
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.hash === '#upload' || this.hash === '#songs') {
                        e.preventDefault();
                        const tabId = this.hash.substring(1);
                        document.querySelector(`.admin-tab[data-tab="${tabId}"]`).click();
                    }
                });
            });
        }
        
        function updateStorageInfo() {
            const uploader = new FileUploaderEnhanced();
            const files = uploader.getAllUploadedFiles();
            
            // Calculate total size
            let totalSize = 0;
            files.forEach(file => {
                totalSize += file.size || 0;
            });
            
            const usedMB = (totalSize / (1024 * 1024)).toFixed(2);
            const maxMB = 50; // LocalStorage limit (approx)
            const percent = Math.min((usedMB / maxMB) * 100, 100);
            
            // Update UI
            document.getElementById('storageUsed').textContent = usedMB + ' MB';
            document.getElementById('fileCount').textContent = files.length;
            document.getElementById('storageProgress').style.width = percent + '%';
            
            // Show warning if storage is almost full
            const storageWarning = document.getElementById('storageWarning');
            if (percent > 80) {
                storageWarning.style.display = 'block';
            } else {
                storageWarning.style.display = 'none';
            }
        }
        
        function loadRecentUploads() {
            const uploader = new FileUploaderEnhanced();
            const files = uploader.getAllUploadedFiles();
            const recentUploads = document.getElementById('recentUploads');
            
            // Sort by upload time (newest first)
            files.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
            
            if (files.length === 0) {
                recentUploads.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #8A8A8A;">
                        <i class="fas fa-file-audio" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p>Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c upload</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            files.slice(0, 10).forEach(file => {
                const date = new Date(file.uploadedAt).toLocaleDateString('vi-VN');
                const size = uploader.formatFileSize(file.size);
                
                html += `
                    <div style="
                        display: flex; align-items: center; justify-content: space-between;
                        padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
                    ">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-audio" style="color: #6C63FF;"></i>
                            <div>
                                <div style="font-weight: 500; color: white;">${file.name}</div>
                                <div style="font-size: 0.8rem; color: #8A8A8A;">${size} ‚Ä¢ ${date}</div>
                            </div>
                        </div>
                        <button class="delete-file-btn" data-key="${file.key}" style="
                            background: rgba(255, 101, 132, 0.2); color: #FF6584; border: none;
                            padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;
                        ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            recentUploads.innerHTML = html;
            
            // Add delete event listeners
            document.querySelectorAll('.delete-file-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const key = this.dataset.key;
                    if (confirm('X√≥a file n√†y?')) {
                        const uploader = new FileUploaderEnhanced();
                        uploader.deleteUploadedFile(key);
                        showNotification('‚úÖ ƒê√£ x√≥a file', 'success');
                        loadRecentUploads();
                        updateStorageInfo();
                        loadStorageFiles();
                    }
                });
            });
        }
        
        function loadStorageFiles() {
            const uploader = new FileUploaderEnhanced();
            const files = uploader.getAllUploadedFiles();
            const storageFiles = document.getElementById('storageFiles');
            
            if (files.length === 0) {
                storageFiles.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #8A8A8A;">
                        <i class="fas fa-database" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p>Kh√¥ng c√≥ file n√†o trong b·ªô nh·ªõ</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="max-height: 200px; overflow-y: auto;">';
            
            files.forEach(file => {
                const date = new Date(file.uploadedAt).toLocaleDateString('vi-VN');
                const size = uploader.formatFileSize(file.size);
                const daysOld = Math.floor((Date.now() - new Date(file.uploadedAt).getTime()) / (1000 * 60 * 60 * 24));
                
                html += `
                    <div style="
                        display: flex; align-items: center; justify-content: space-between;
                        padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
                    ">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                            <input type="checkbox" class="file-checkbox" data-key="${file.key}" style="margin-right: 5px;">
                            <i class="fas fa-file-audio" style="color: #6C63FF;"></i>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
                                <div style="font-size: 0.8rem; color: #8A8A8A;">${size} ‚Ä¢ ${date} ‚Ä¢ ${daysOld} ng√†y</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            storageFiles.innerHTML = html;
        }
        
        function cleanOldFiles() {
            const uploader = new FileUploaderEnhanced();
            const files = uploader.getAllUploadedFiles();
            const cutoffTime = Date.now() - (7 * 24 * 60 * 60 * 1000); // 7 days
            
            let deletedCount = 0;
            
            files.forEach(file => {
                if (new Date(file.uploadedAt).getTime() < cutoffTime) {
                    uploader.deleteUploadedFile(file.key);
                    deletedCount++;
                }
            });
            
            showNotification(`‚úÖ ƒê√£ x√≥a ${deletedCount} file c≈©`, 'success');
            updateStorageInfo();
            loadStorageFiles();
            loadRecentUploads();
        }
        
        function cleanAllFiles() {
            if (confirm('X√ìA T·∫§T C·∫¢ FILE UPLOAD?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                const uploader = new FileUploaderEnhanced();
                const files = uploader.getAllUploadedFiles();
                
                files.forEach(file => {
                    uploader.deleteUploadedFile(file.key);
                });
                
                showNotification(`‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ ${files.length} file`, 'success');
                updateStorageInfo();
                loadStorageFiles();
                loadRecentUploads();
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#FF6584' : '#6C63FF'};
                color: white; padding: 12px 20px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999;
                animation: slideIn 0.3s ease;
                display: flex; align-items: center; gap: 10px;
            `;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            notification.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .form-control {
                width: 100%; padding: 8px 12px; margin-top: 5px;
                background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
                border-radius: 6px; color: white; font-size: 0.9rem;
            }
            .form-control:focus {
                outline: none; border-color: #6C63FF;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
