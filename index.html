<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VGMEDIA - N·ªÅn t·∫£ng nh·∫°c DJ Remix</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    <style>
        /* Additional styles for enhanced features */
        .player-visualization {
            position: relative;
            height: 300px;
            background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(18,18,18,1) 100%);
            border-radius: var(--radius-lg);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .disc-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
        
        .disc {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, #111 30%, #222 70%, #333 100%);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            animation: disc-rotate 20s linear infinite;
            animation-play-state: paused;
        }
        
        .disc-grooves {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            border-radius: 50%;
            background: repeating-radial-gradient(
                circle at center,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.05) 2px,
                rgba(255,255,255,0.05) 4px
            );
        }
        
        .disc-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6C63FF, #FF6584);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
        }
        
        .disc-center-inner {
            width: 12px;
            height: 12px;
            background: #121212;
            border-radius: 50%;
        }
        
        .disc-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #121212;
            font-size: 12px;
            text-align: center;
            padding: 10px;
        }
        
        .audio-visualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .light-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), 
                rgba(108, 99, 255, 0.3) 0%, 
                rgba(255, 101, 132, 0.1) 40%, 
                transparent 70%);
            pointer-events: none;
            transition: background 0.1s;
        }
        
        @keyframes disc-rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .playing .disc {
            animation-play-state: running;
        }
        
        .category-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .category-filter {
            padding: 8px 20px;
            background: var(--dark-lighter);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            color: var(--gray-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .category-filter:hover,
        .category-filter.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary);
        }
        
        .upload-section {
            display: none;
        }
        
        .upload-section.visible {
            display: block;
        }
        
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: var(--radius-lg);
            padding: 40px;
            text-align: center;
            background: rgba(108, 99, 255, 0.05);
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background: rgba(108, 99, 255, 0.1);
            border-color: var(--secondary);
        }
        
        .upload-preview {
            display: none;
            margin-top: 20px;
        }
        
        .upload-preview.active {
            display: block;
        }
        
        .file-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--dark-lighter);
            padding: 15px;
            border-radius: var(--radius-md);
            margin-top: 15px;
        }
        
        .file-preview i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .library-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background: var(--dark-lighter);
            padding: 20px;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary);
        }
        
        .stat-card h4 {
            color: var(--gray);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .stat-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--light);
        }
        
        .admin-only-tag {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .login-required {
            text-align: center;
            padding: 40px;
            background: rgba(108, 99, 255, 0.1);
            border-radius: var(--radius-lg);
            margin: 20px 0;
        }
        
        .login-required i {
            font-size: 3rem;
            color: #6C63FF;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <span class="logo-icon">üéµ</span>
                    <h1 class="logo-text">VG<span class="logo-highlight">MEDIA</span></h1>
                </div>
                
                <div class="nav-links">
                    <a href="#" class="nav-link active"><i class="fas fa-home"></i> Trang ch·ªß</a>
                    <a href="#library" class="nav-link"><i class="fas fa-music"></i> Th∆∞ vi·ªán</a>
                    <a href="#categories" class="nav-link"><i class="fas fa-tags"></i> Danh m·ª•c</a>
                    <a href="#upload" class="nav-link" id="uploadNavLink" style="display:none;">
                        <i class="fas fa-upload"></i> Upload
                        <span class="admin-only-tag">Admin</span>
                    </a>
                    <a href="./admin.html" class="nav-link" id="adminNavLink" style="display:none;">
                        <i class="fas fa-cog"></i> Qu·∫£n l√Ω
                    </a>
                </div>
                
                <div class="nav-actions">
                    <div class="user-menu" id="userMenu" style="display:none;">
                        <span id="userName">User</span>
                        <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                    <button class="btn-login" id="loginBtn">ƒêƒÉng nh·∫≠p</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- Player Section -->
            <div class="player-container" id="playerSection">
                <div class="player-card">
                    <!-- Enhanced Player Visualization -->
                    <div class="player-visualization" id="playerVisualization">
                        <canvas class="audio-visualizer" id="audioVisualizer"></canvas>
                        <div class="light-effects" id="lightEffects"></div>
                        
                        <div class="disc-container">
                            <div class="disc" id="disc">
                                <div class="disc-grooves"></div>
                                <div class="disc-label">VGMEDIA</div>
                                <div class="disc-center">
                                    <div class="disc-center-inner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Song Info -->
                    <div class="song-info">
                        <div class="song-thumbnail">
                            <img id="currentThumbnail" src="https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?auto=format&fit=crop&w=500&q=80" alt="Song Thumbnail">
                            <div class="song-badge premium" id="currentBadge">PREMIUM</div>
                        </div>
                        
                        <div class="song-details">
                            <h2 class="song-title" id="currentTitle">Ch√†o m·ª´ng ƒë·∫øn VGMEDIA</h2>
                            <p class="song-artist" id="currentArtist">H√£y ch·ªçn b√†i h√°t ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            
                            <div class="song-meta" id="songMeta">
                                <span class="song-duration" id="currentDuration"><i class="fas fa-clock"></i> 0:00</span>
                                <span class="song-genre" id="currentGenre"><i class="fas fa-tag"></i> --</span>
                                <span class="song-bpm" id="currentBPM"><i class="fas fa-tachometer-alt"></i> -- BPM</span>
                                <span class="song-size" id="currentSize"><i class="fas fa-database"></i> -- MB</span>
                            </div>
                            
                            <p class="song-description" id="currentDescription">
                                N·ªÅn t·∫£ng nh·∫°c ch·∫•t l∆∞·ª£ng cao. ƒêƒÉng nh·∫≠p ƒë·ªÉ tr·∫£i nghi·ªám ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng.
                            </p>
                            
                            <div class="song-actions">
                                <button class="btn-action btn-play" id="playBtn">
                                    <i class="fas fa-play"></i> Ph√°t nh·∫°c
                                </button>
                                <button class="btn-action btn-pause" id="pauseBtn">
                                    <i class="fas fa-pause"></i> T·∫°m d·ª´ng
                                </button>
                                <button class="btn-action btn-like" id="likeBtn">
                                    <i class="far fa-heart"></i> Y√™u th√≠ch
                                </button>
                                <button class="btn-action btn-download" id="downloadBtn">
                                    <i class="fas fa-download"></i> T·∫£i xu·ªëng
                                </button>
                                <button class="btn-action btn-buy" id="buyBtn">
                                    <i class="fas fa-shopping-cart"></i> Mua b√†i h√°t
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Player Controls -->
                    <div class="player-controls">
                        <div class="progress-container">
                            <div class="progress-time current-time" id="currentTime">00:00</div>
                            <div class="progress-bar" id="progressBar">
                                <div class="progress" id="songProgress"></div>
                                <div class="progress-handle" id="progressHandle"></div>
                            </div>
                            <div class="progress-time total-time" id="totalTime">00:00</div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="control-btn" id="prevBtn">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button class="control-btn btn-play-main" id="playMainBtn">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="control-btn" id="nextBtn">
                                <i class="fas fa-step-forward"></i>
                            </button>
                            
                            <div class="volume-control">
                                <i class="fas fa-volume-up volume-icon" id="volumeIcon"></i>
                                <input type="range" min="0" max="100" value="80" class="volume-slider" id="volumeSlider">
                            </div>
                            
                            <button class="control-btn" id="repeatBtn">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Upload Section - CH·ªà HI·ªÇN TH·ªä CHO ADMIN -->
            <div class="music-library upload-section" id="upload">
                <div class="library-header">
                    <h3><i class="fas fa-upload"></i> Upload nh·∫°c t·ª´ m√°y t√≠nh</h3>
                    <small style="color: #FFD700; font-weight: 500;">
                        <i class="fas fa-crown"></i> Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn upload
                    </small>
                </div>
                
                <div class="login-required" id="uploadLoginRequired">
                    <i class="fas fa-lock"></i>
                    <h4>Vui l√≤ng ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n Admin</h4>
                    <p>Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn upload b√†i h√°t l√™n h·ªá th·ªëng</p>
                    <button class="btn-action btn-play" onclick="window.location.href='./login.html'">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p Admin
                    </button>
                </div>
                
                <div id="uploadAreaWrapper" style="display: none;">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #6C63FF; margin-bottom: 15px;"></i>
                        <h4>K√©o th·∫£ file nh·∫°c v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn file</h4>
                        <p>H·ªó tr·ª£ file MP3, WAV, OGG, FLAC, M4A (t·ªëi ƒëa 500MB)</p>
                        <input type="file" id="fileInput" accept="audio/*,.mp3,.wav,.ogg,.flac,.m4a,.aac" style="display: none;">
                    </div>
                    
                    <div class="upload-preview" id="uploadPreview">
                        <div class="file-preview">
                            <i class="fas fa-file-audio"></i>
                            <div>
                                <div id="fileName">--</div>
                                <div id="fileInfo" style="font-size: 0.9rem; color: #8A8A8A;">--</div>
                            </div>
                            <button class="btn-action" id="uploadBtn" style="margin-left: auto;">
                                <i class="fas fa-upload"></i> Upload
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Categories -->
            <div class="music-library" id="categories">
                <div class="library-header">
                    <h3><i class="fas fa-tags"></i> Danh m·ª•c th·ªÉ lo·∫°i</h3>
                </div>
                
                <div class="category-filters">
                    <div class="category-filter active" data-genre="all">T·∫•t c·∫£</div>
                    <div class="category-filter" data-genre="EDM">EDM</div>
                    <div class="category-filter" data-genre="House">House</div>
                    <div class="category-filter" data-genre="Techno">Techno</div>
                    <div class="category-filter" data-genre="Trance">Trance</div>
                    <div class="category-filter" data-genre="Dubstep">Dubstep</div>
                    <div class="category-filter" data-genre="Pop">Pop</div>
                    <div class="category-filter" data-genre="Hip Hop">Hip Hop</div>
                    <div class="category-filter" data-genre="Rock">Rock</div>
                    <div class="category-filter" data-genre="Jazz">Jazz</div>
                </div>
            </div>
            
            <!-- Music Library -->
            <div class="music-library" id="library">
                <div class="library-header">
                    <h3><i class="fas fa-music"></i> Th∆∞ vi·ªán nh·∫°c VGMEDIA</h3>
                    <div class="library-filters">
                        <button class="filter-btn active" data-filter="all">T·∫•t c·∫£</button>
                        <button class="filter-btn" data-filter="free">Mi·ªÖn ph√≠</button>
                        <button class="filter-btn" data-filter="premium">Premium</button>
                    </div>
                </div>
                
                <!-- Library Stats -->
                <div class="library-stats">
                    <div class="stat-card">
                        <h4>T·ªïng s·ªë b√†i h√°t</h4>
                        <p id="totalSongs">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Mi·ªÖn ph√≠</h4>
                        <p id="freeSongs">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Premium</h4>
                        <p id="premiumSongs">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>T·ªïng th·ªùi l∆∞·ª£ng</h4>
                        <p id="totalDuration">0 gi·ªù</p>
                    </div>
                </div>
                
                <div class="songs-list" id="songsList">
                    <!-- Songs will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Enhanced Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>VG<span>MEDIA</span></h2>
                    <p>N·ªÅn t·∫£ng nh·∫°c ch·∫•t l∆∞·ª£ng cao h√†ng ƒë·∫ßu Vi·ªát Nam</p>
                    <div class="social-links" style="margin-top: 20px;">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-tiktok"></i></a>
                    </div>
                </div>
                
                <div class="footer-links">
                    <div class="footer-column">
                        <h4>Kh√°m ph√°</h4>
                        <a href="#playerSection">Nghe nh·∫°c</a>
                        <a href="#library">Th∆∞ vi·ªán</a>
                        <a href="#categories">Th·ªÉ lo·∫°i</a>
                    </div>
                    
                    <div class="footer-column">
                        <h4>T√†i kho·∫£n</h4>
                        <a href="./login.html" id="footerLogin">ƒêƒÉng nh·∫≠p</a>
                        <a href="./login.html" id="footerRegister">ƒêƒÉng k√Ω</a>
                        <a href="#" id="footerPremium">Premium</a>
                        <a href="#" id="footerHelp">H·ªó tr·ª£</a>
                    </div>
                    
                    <div class="footer-column">
                        <h4>VGMEDIA</h4>
                        <a href="#">V·ªÅ ch√∫ng t√¥i</a>
                        <a href="#">ƒêi·ªÅu kho·∫£n</a>
                        <a href="#">B·∫£o m·∫≠t</a>
                        <a href="#">Li√™n h·ªá</a>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 VGMEDIA. All rights reserved. | <span id="currentYear"></span></p>
                <p style="color: #8A8A8A; font-size: 0.9rem; margin-top: 5px;">
                    <i class="fas fa-headphones"></i> ƒêang ph√°t: <span id="footerCurrentSong">Ch∆∞a c√≥ b√†i h√°t</span>
                </p>
            </div>
        </div>
    </footer>

    <!-- Audio Element -->
    <audio id="audioPlayer" preload="metadata"></audio>

    <!-- JavaScript -->
    <script src="./js/music-data.js"></script>
    <script src="./js/auth-fixed.js"></script>
    <script src="./js/file-upload-enhanced.js"></script>
    
    <script>
        // Main Application Script - COMPLETE VERSION
        console.log('üéµ VGMEDIA Player Enhanced Loaded');
        
        // Global variables
        let currentSongId = null;
        let isPlaying = false;
        let repeatMode = 'off'; // 'off', 'all', 'one'
        let selectedFile = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing VGMEDIA Enhanced Player...');
            
            // Initialize all components
            initAuth();
            initPlayer();
            initUpload();
            initLibrary();
            initVisualizer();
            
            // Setup event listeners
            setupEventListeners();
            
            console.log('‚úÖ VGMEDIA Ready!');
        });
        
        // 1. AUTHENTICATION INIT
        function initAuth() {
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            const loginBtn = document.getElementById('loginBtn');
            const userMenu = document.getElementById('userMenu');
            const userName = document.getElementById('userName');
            const adminNavLink = document.getElementById('adminNavLink');
            const uploadNavLink = document.getElementById('uploadNavLink');
            const footerLogin = document.getElementById('footerLogin');
            const footerRegister = document.getElementById('footerRegister');
            const footerPremium = document.getElementById('footerPremium');
            
            if (user) {
                // User is logged in
                loginBtn.style.display = 'none';
                userMenu.style.display = 'flex';
                userName.textContent = user.name;
                
                // Check if user is admin
                if (user.type === 'admin') {
                    adminNavLink.style.display = 'flex';
                    uploadNavLink.style.display = 'flex';
                    document.querySelector('.upload-section').classList.add('visible');
                    document.getElementById('uploadLoginRequired').style.display = 'none';
                    document.getElementById('uploadAreaWrapper').style.display = 'block';
                }
                
                // Update footer
                if (footerLogin) {
                    footerLogin.textContent = 'Xin ch√†o, ' + user.name;
                    footerLogin.href = '#';
                    footerLogin.onclick = () => showUserInfo(user);
                }
                
                if (footerRegister) footerRegister.style.display = 'none';
                
                if (footerPremium) {
                    if (user.isPremium || user.type === 'admin') {
                        footerPremium.innerHTML = '<i class="fas fa-crown"></i> Premium Member';
                        footerPremium.style.color = '#FFD700';
                    } else {
                        footerPremium.innerHTML = '<i class="fas fa-crown"></i> N√¢ng c·∫•p Premium';
                    }
                }
                
            } else {
                // User is not logged in
                loginBtn.style.display = 'block';
                userMenu.style.display = 'none';
                adminNavLink.style.display = 'none';
                uploadNavLink.style.display = 'none';
                
                // Show login required for upload section
                document.querySelector('.upload-section').classList.add('visible');
                document.getElementById('uploadLoginRequired').style.display = 'block';
                document.getElementById('uploadAreaWrapper').style.display = 'none';
            }
            
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();
        }
        
        // 2. PLAYER INIT
        function initPlayer() {
            const audioPlayer = document.getElementById('audioPlayer');
            const volumeSlider = document.getElementById('volumeSlider');
            
            if (audioPlayer) {
                audioPlayer.volume = volumeSlider ? volumeSlider.value / 100 : 0.8;
            }
            
            // Load first song if exists
            const songs = window.getMusicLibrary ? window.getMusicLibrary() : [];
            if (songs.length > 0) {
                loadSong(songs[0].id);
            }
        }
        
        // 3. UPLOAD INIT - CH·ªà CHO ADMIN
        function initUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadPreview = document.getElementById('uploadPreview');
            const uploadBtn = document.getElementById('uploadBtn');
            
            // Ki·ªÉm tra quy·ªÅn admin
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            if (!user || user.type !== 'admin') {
                return; // Kh√¥ng init upload cho user th∆∞·ªùng
            }
            
            if (!uploadArea || !fileInput) return;
            
            // Click upload area to trigger file input
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#FF6584';
                uploadArea.style.background = 'rgba(108, 99, 255, 0.1)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#6C63FF';
                uploadArea.style.background = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#6C63FF';
                uploadArea.style.background = '';
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
            
            // Upload button
            if (uploadBtn) {
                uploadBtn.addEventListener('click', uploadFile);
            }
        }
        
        // 4. LIBRARY INIT
        function initLibrary() {
            loadMusicLibrary();
            updateLibraryStats();
        }
        
        // 5. VISUALIZER INIT
        function initVisualizer() {
            const canvas = document.getElementById('audioVisualizer');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Store context for later use
            window.audioVisualizer = { canvas, ctx };
        }
        
        // 6. EVENT LISTENERS SETUP
        function setupEventListeners() {
            // Login button
            document.getElementById('loginBtn')?.addEventListener('click', () => {
                window.location.href = './login.html';
            });
            
            // Logout button
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                    if (window.logout) {
                        window.logout();
                        location.reload();
                    }
                }
            });
            
            // Player controls
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const playMainBtn = document.getElementById('playMainBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            const repeatBtn = document.getElementById('repeatBtn');
            const progressBar = document.getElementById('progressBar');
            const audioPlayer = document.getElementById('audioPlayer');
            const likeBtn = document.getElementById('likeBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const buyBtn = document.getElementById('buyBtn');
            
            // Play buttons
            if (playBtn) playBtn.addEventListener('click', togglePlayPause);
            if (playMainBtn) playMainBtn.addEventListener('click', togglePlayPause);
            if (pauseBtn) pauseBtn.addEventListener('click', pauseCurrentSong);
            
            // Navigation buttons
            if (prevBtn) prevBtn.addEventListener('click', playPreviousSong);
            if (nextBtn) nextBtn.addEventListener('click', playNextSong);
            
            // Volume control
            if (volumeSlider) {
                volumeSlider.addEventListener('input', function() {
                    if (audioPlayer) {
                        audioPlayer.volume = this.value / 100;
                        const icon = document.getElementById('volumeIcon');
                        if (icon) {
                            if (this.value == 0) {
                                icon.className = 'fas fa-volume-mute volume-icon';
                            } else if (this.value < 50) {
                                icon.className = 'fas fa-volume-down volume-icon';
                            } else {
                                icon.className = 'fas fa-volume-up volume-icon';
                            }
                        }
                    }
                });
            }
            
            // Repeat button
            if (repeatBtn) {
                repeatBtn.addEventListener('click', function() {
                    if (repeatMode === 'off') {
                        repeatMode = 'all';
                        this.style.color = '#6C63FF';
                        this.title = 'L·∫∑p l·∫°i t·∫•t c·∫£';
                        showNotification('üîÇ L·∫∑p l·∫°i t·∫•t c·∫£ b√†i h√°t');
                    } else if (repeatMode === 'all') {
                        repeatMode = 'one';
                        this.style.color = '#FF6584';
                        this.title = 'L·∫∑p l·∫°i m·ªôt b√†i';
                        showNotification('üîÅ L·∫∑p l·∫°i m·ªôt b√†i');
                    } else {
                        repeatMode = 'off';
                        this.style.color = '';
                        this.title = 'Kh√¥ng l·∫∑p l·∫°i';
                        showNotification('‚èπÔ∏è Kh√¥ng l·∫∑p l·∫°i');
                    }
                });
            }
            
            // Progress bar click
            if (progressBar && audioPlayer) {
                progressBar.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    audioPlayer.currentTime = percent * audioPlayer.duration;
                });
            }
            
            // Audio player events
            if (audioPlayer) {
                audioPlayer.addEventListener('timeupdate', updateProgress);
                audioPlayer.addEventListener('loadedmetadata', function() {
                    document.getElementById('totalTime').textContent = formatTime(this.duration);
                });
                audioPlayer.addEventListener('play', function() {
                    document.body.classList.add('playing');
                    isPlaying = true;
                    updateVisualizer(true);
                });
                audioPlayer.addEventListener('pause', function() {
                    document.body.classList.remove('playing');
                    isPlaying = false;
                    updateVisualizer(false);
                });
                audioPlayer.addEventListener('ended', handleSongEnded);
                audioPlayer.addEventListener('error', function(e) {
                    console.error('Audio player error:', e);
                    showNotification('‚ùå L·ªói ph√°t nh·∫°c. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                });
            }
            
            // Like button
            if (likeBtn) {
                likeBtn.addEventListener('click', function() {
                    if (!currentSongId) return;
                    
                    this.classList.toggle('liked');
                    const icon = this.querySelector('i');
                    if (icon.classList.contains('far')) {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        this.style.background = '#FF6584';
                        showNotification('‚ù§Ô∏è ƒê√£ th√™m v√†o y√™u th√≠ch!');
                    } else {
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        this.style.background = '';
                        showNotification('üíî ƒê√£ x√≥a kh·ªèi y√™u th√≠ch!');
                    }
                });
            }
            
            // Download button
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function() {
                    if (!currentSongId) {
                        showNotification('Vui l√≤ng ch·ªçn b√†i h√°t ƒë·ªÉ t·∫£i', 'error');
                        return;
                    }
                    
                    const song = window.getSongById ? window.getSongById(currentSongId) : null;
                    if (!song) return;
                    
                    const user = window.getCurrentUser ? window.getCurrentUser() : null;
                    
                    // Ki·ªÉm tra quy·ªÅn download
                    if (song.type === 'premium') {
                        if (!user) {
                            showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫£i b√†i h√°t premium', 'error');
                            return;
                        }
                        
                        if (!user.isPremium && !(user.purchasedSongs && user.purchasedSongs.includes(currentSongId))) {
                            showNotification('Vui l√≤ng mua b√†i h√°t premium ƒë·ªÉ t·∫£i', 'error');
                            return;
                        }
                    }
                    
                    showNotification(`üì• ƒêang t·∫£i xu·ªëng: ${song.title}...`);
                    
                    // T·∫°o link download
                    const link = document.createElement('a');
                    link.href = song.audioUrl;
                    link.download = `${song.title} - ${song.artist}.mp3`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }
            
            // Buy button
            if (buyBtn) {
                buyBtn.addEventListener('click', function() {
                    if (!currentSongId) return;
                    
                    const song = window.getSongById ? window.getSongById(currentSongId) : null;
                    if (!song) return;
                    
                    const user = window.getCurrentUser ? window.getCurrentUser() : null;
                    
                    if (song.type === 'free') {
                        // Download free song
                        showNotification('üì• ƒêang t·∫£i xu·ªëng b√†i h√°t mi·ªÖn ph√≠...');
                        const link = document.createElement('a');
                        link.href = song.audioUrl;
                        link.download = `${song.title} - ${song.artist}.mp3`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        // Premium song - show purchase modal
                        if (!user) {
                            showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua b√†i h√°t', 'error');
                            return;
                        }
                        
                        if (user.isPremium) {
                            showNotification('üéâ B·∫°n ƒë√£ l√† Premium member! C√≥ th·ªÉ nghe v√† t·∫£i t·∫•t c·∫£ b√†i h√°t.', 'success');
                            return;
                        }
                        
                        if (user.purchasedSongs && user.purchasedSongs.includes(currentSongId)) {
                            showNotification('‚úÖ B·∫°n ƒë√£ mua b√†i h√°t n√†y r·ªìi!', 'success');
                            return;
                        }
                        
                        showPurchaseModal(song);
                    }
                });
            }
            
            // Category filters
            document.querySelectorAll('.category-filter').forEach(filter => {
                filter.addEventListener('click', function() {
                    document.querySelectorAll('.category-filter').forEach(f => f.classList.remove('active'));
                    this.classList.add('active');
                    
                    const genre = this.dataset.genre;
                    filterSongsByGenre(genre);
                });
            });
            
            // Library filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filter = this.dataset.filter;
                    filterSongsByType(filter);
                });
            });
            
            // Window resize
            window.addEventListener('resize', function() {
                const canvas = document.getElementById('audioVisualizer');
                if (canvas) {
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                }
                if (isPlaying) {
                    updateVisualizer(true);
                }
            });
        }
        
        // ==================== CORE FUNCTIONS ====================
        
        // Load song by ID
        function loadSong(songId) {
            currentSongId = songId;
            
            const song = window.getSongById ? window.getSongById(songId) : null;
            if (!song) {
                console.error('Song not found:', songId);
                return;
            }
            
            // Update UI
            document.getElementById('currentTitle').textContent = song.title;
            document.getElementById('currentArtist').textContent = song.artist;
            document.getElementById('currentDuration').innerHTML = `<i class="fas fa-clock"></i> ${song.duration}`;
            document.getElementById('currentGenre').innerHTML = `<i class="fas fa-tag"></i> ${song.genre || 'EDM'}`;
            document.getElementById('currentBPM').innerHTML = `<i class="fas fa-tachometer-alt"></i> ${song.bpm || '128 BPM'}`;
            
            // Calculate file size
            const fileSize = song.fileSize ? song.fileSize : 'Unknown';
            document.getElementById('currentSize').innerHTML = `<i class="fas fa-database"></i> ${fileSize}`;
            
            const thumbnail = document.getElementById('currentThumbnail');
            if (thumbnail) {
                thumbnail.src = song.thumbnail || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f';
            }
            
            document.getElementById('currentDescription').textContent = song.description || 'B√†i h√°t ch·∫•t l∆∞·ª£ng cao t·ª´ VGMEDIA';
            
            // Update badge
            const badge = document.getElementById('currentBadge');
            if (badge) {
                badge.textContent = song.type === 'premium' ? 'PREMIUM' : 'FREE';
                badge.className = `song-badge ${song.type}`;
            }
            
            // Update buy button
            const buyBtn = document.getElementById('buyBtn');
            if (buyBtn) {
                const user = window.getCurrentUser ? window.getCurrentUser() : null;
                
                if (song.type === 'free') {
                    buyBtn.innerHTML = '<i class="fas fa-download"></i> T·∫£i mi·ªÖn ph√≠';
                    buyBtn.style.background = '';
                } else {
                    const price = song.price ? song.price.toLocaleString('vi-VN') + 'ƒë' : '199,000ƒë';
                    
                    if (user) {
                        if (user.isPremium) {
                            buyBtn.innerHTML = '<i class="fas fa-crown"></i> Premium Member';
                            buyBtn.style.background = '#FFD700';
                            buyBtn.style.color = '#000';
                            buyBtn.disabled = true;
                        } else if (user.purchasedSongs && user.purchasedSongs.includes(songId)) {
                            buyBtn.innerHTML = '<i class="fas fa-check-circle"></i> ƒê√£ mua';
                            buyBtn.style.background = '#4CAF50';
                            buyBtn.disabled = true;
                        } else {
                            buyBtn.innerHTML = `<i class="fas fa-shopping-cart"></i> Mua - ${price}`;
                            buyBtn.style.background = '';
                            buyBtn.disabled = false;
                        }
                    } else {
                        buyBtn.innerHTML = `<i class="fas fa-shopping-cart"></i> Mua - ${price}`;
                        buyBtn.style.background = '';
                        buyBtn.disabled = false;
                    }
                }
            }
            
            // Update audio player
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                audioPlayer.src = song.audioUrl;
                
                // Check if user can play full song
                const user = window.getCurrentUser ? window.getCurrentUser() : null;
                if (song.type === 'premium' && user && !user.isPremium && 
                    !(user.purchasedSongs && user.purchasedSongs.includes(songId))) {
                    audioPlayer.dataset.introEnd = '150'; // 2:30 minutes
                } else {
                    delete audioPlayer.dataset.introEnd;
                }
            }
            
            // Update footer
            document.getElementById('footerCurrentSong').textContent = `${song.title} - ${song.artist}`;
            
            // Update active song in library
            document.querySelectorAll('.song-item').forEach(item => {
                const itemId = parseInt(item.dataset.id);
                if (itemId === songId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Reset progress
            updateProgress();
        }
        
        // Load music library
        function loadMusicLibrary() {
            const songsList = document.getElementById('songsList');
            if (!songsList) return;
            
            const songs = window.getMusicLibrary ? window.getMusicLibrary() : [];
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            
            if (songs.length === 0) {
                songsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8A8A8A; grid-column: 1 / -1;">
                        <i class="fas fa-music" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h4>Th∆∞ vi·ªán nh·∫°c tr·ªëng</h4>
                        <p>H√£y ƒëƒÉng nh·∫≠p Admin v√† th√™m b√†i h√°t ƒë·∫ßu ti√™n!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            songs.forEach(song => {
                const canPlay = song.type === 'free' || 
                               (user && (user.isPremium || 
                               (user.purchasedSongs && user.purchasedSongs.includes(song.id))));
                
                const priceDisplay = song.type === 'free' ? 
                    '<span style="color: #4CAF50;"><i class="fas fa-unlock"></i> Mi·ªÖn ph√≠</span>' :
                    `<span style="color: #FF6584;">${song.price ? song.price.toLocaleString('vi-VN') + 'ƒë' : '199,000ƒë'}</span>`;
                
                html += `
                    <div class="song-item" data-id="${song.id}" onclick="playSelectedSong(${song.id})">
                        <img src="${song.thumbnail || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f'}" 
                             alt="${song.title}" 
                             class="song-item-img">
                        <div class="song-item-info">
                            <div class="song-item-title">
                                ${song.title}
                                ${!canPlay ? '<span style="margin-left: 8px; font-size: 12px; color: #FF6584;"><i class="fas fa-lock"></i></span>' : ''}
                            </div>
                            <div class="song-item-artist">${song.artist}</div>
                            <div class="song-item-meta">
                                <span><i class="fas fa-clock"></i> ${song.duration}</span>
                                <span><i class="fas fa-tag"></i> ${song.genre || 'EDM'}</span>
                                <span><i class="fas fa-fire"></i> ${song.bpm || '128 BPM'}</span>
                            </div>
                        </div>
                        <div class="song-item-price ${song.type === 'free' ? 'free' : ''}">
                            ${priceDisplay}
                        </div>
                    </div>
                `;
            });
            
            songsList.innerHTML = html;
        }
        
        // Play selected song
        window.playSelectedSong = function(songId) {
            loadSong(songId);
            playCurrentSong();
        };
        
        // Toggle play/pause
        function togglePlayPause() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (!audioPlayer || !audioPlayer.src) {
                showNotification('Kh√¥ng c√≥ b√†i h√°t ƒë·ªÉ ph√°t', 'error');
                return;
            }
            
            if (isPlaying) {
                pauseCurrentSong();
            } else {
                playCurrentSong();
            }
        }
        
        // Play current song
        function playCurrentSong() {
            const audioPlayer = document.getElementById('audioPlayer');
            const playBtn = document.getElementById('playBtn');
            const playMainBtn = document.getElementById('playMainBtn');
            
            if (!audioPlayer || !audioPlayer.src) {
                showNotification('Kh√¥ng c√≥ b√†i h√°t ƒë·ªÉ ph√°t', 'error');
                return;
            }
            
            // Ki·ªÉm tra quy·ªÅn nghe (ch·ªâ cho premium songs)
            const song = window.getSongById ? window.getSongById(currentSongId) : null;
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            
            if (song && song.type === 'premium') {
                if (!user) {
                    showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ nghe b√†i h√°t premium', 'error');
                    return;
                }
                
                if (!user.isPremium && !(user.purchasedSongs && user.purchasedSongs.includes(currentSongId))) {
                    showNotification('Vui l√≤ng mua b√†i h√°t premium ƒë·ªÉ nghe', 'error');
                    return;
                }
            }
            
            audioPlayer.play()
                .then(() => {
                    if (playBtn) playBtn.innerHTML = '<i class="fas fa-pause"></i> T·∫°m d·ª´ng';
                    if (playMainBtn) playMainBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    
                    showNotification('üéµ ƒêang ph√°t nh·∫°c...', 'success');
                })
                .catch(error => {
                    console.error('Play error:', error);
                    showNotification('Kh√¥ng th·ªÉ ph√°t nh·∫°c. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                });
        }
        
        // Pause current song
        function pauseCurrentSong() {
            const audioPlayer = document.getElementById('audioPlayer');
            const playBtn = document.getElementById('playBtn');
            const playMainBtn = document.getElementById('playMainBtn');
            
            if (audioPlayer) {
                audioPlayer.pause();
                if (playBtn) playBtn.innerHTML = '<i class="fas fa-play"></i> Ph√°t nh·∫°c';
                if (playMainBtn) playMainBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        }
        
        // Play next song
        function playNextSong() {
            const songs = window.getMusicLibrary ? window.getMusicLibrary() : [];
            if (songs.length === 0) return;
            
            const currentId = currentSongId || songs[0].id;
            const currentIndex = songs.findIndex(s => s.id === currentId);
            
            if (currentIndex >= 0 && currentIndex < songs.length - 1) {
                loadSong(songs[currentIndex + 1].id);
                playCurrentSong();
            } else {
                loadSong(songs[0].id);
                playCurrentSong();
            }
        }
        
        // Play previous song
        function playPreviousSong() {
            const songs = window.getMusicLibrary ? window.getMusicLibrary() : [];
            if (songs.length === 0) return;
            
            const currentId = currentSongId || songs[0].id;
            const currentIndex = songs.findIndex(s => s.id === currentId);
            
            if (currentIndex > 0) {
                loadSong(songs[currentIndex - 1].id);
                playCurrentSong();
            } else {
                loadSong(songs[songs.length - 1].id);
                playCurrentSong();
            }
        }
        
        // Update progress bar
        function updateProgress() {
            const audioPlayer = document.getElementById('audioPlayer');
            const progress = document.getElementById('songProgress');
            const currentTimeEl = document.getElementById('currentTime');
            
            if (!audioPlayer) return;
            
            const currentTime = audioPlayer.currentTime || 0;
            const duration = audioPlayer.duration || 1;
            const percent = (currentTime / duration) * 100;
            
            if (progress) {
                progress.style.width = percent + '%';
            }
            
            if (currentTimeEl) {
                currentTimeEl.textContent = formatTime(currentTime);
            }
            
            // Check intro for premium songs
            const introEnd = audioPlayer.dataset.introEnd;
            if (introEnd && currentTime >= parseInt(introEnd)) {
                audioPlayer.pause();
                const song = window.getSongById ? window.getSongById(currentSongId) : null;
                if (song) {
                    showPurchaseModal(song);
                }
            }
        }
        
        // Format time
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '00:00';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        // Update visualizer
        function updateVisualizer(isPlaying) {
            if (!isPlaying) {
                const visualizer = window.audioVisualizer;
                if (visualizer) {
                    const { canvas, ctx } = visualizer;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                return;
            }
            
            const visualizer = window.audioVisualizer;
            if (!visualizer) return;
            
            const { canvas, ctx } = visualizer;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw visualizer bars
            const barCount = 128;
            const barWidth = canvas.width / barCount;
            const centerY = canvas.height / 2;
            
            for (let i = 0; i < barCount; i++) {
                // T·∫°o hi·ªáu ·ª©ng wave v·ªõi randomness
                const time = Date.now() / 1000;
                const frequency = 0.5 + (i / barCount) * 2;
                const amplitude = Math.sin(time * frequency + i * 0.1) * 0.5 + 0.5;
                
                const height = amplitude * canvas.height * 0.3;
                const x = i * barWidth;
                const y = centerY - height / 2;
                
                // Create gradient
                const gradient = ctx.createLinearGradient(x, y, x, y + height);
                gradient.addColorStop(0, '#6C63FF');
                gradient.addColorStop(0.5, '#FF6584');
                gradient.addColorStop(1, '#6C63FF');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth - 1, height);
            }
            
            // Update light effects
            const lightEffects = document.getElementById('lightEffects');
            if (lightEffects) {
                const time = Date.now() / 1000;
                const x = 50 + Math.sin(time * 0.5) * 30;
                const y = 50 + Math.cos(time * 0.3) * 30;
                lightEffects.style.setProperty('--x', x + '%');
                lightEffects.style.setProperty('--y', y + '%');
            }
            
            // Continue animation if playing
            if (isPlaying) {
                requestAnimationFrame(() => updateVisualizer(isPlaying));
            }
        }
        
        // Handle file selection for upload
        function handleFileSelect(file) {
            if (!file) return;
            
            // Ki·ªÉm tra quy·ªÅn admin
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            if (!user || user.type !== 'admin') {
                showNotification('‚ùå Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn upload b√†i h√°t!', 'error');
                return;
            }
            
            const fileName = document.getElementById('fileName');
            const fileInfo = document.getElementById('fileInfo');
            const uploadPreview = document.getElementById('uploadPreview');
            
            if (fileName) fileName.textContent = file.name;
            if (fileInfo) {
                const size = (file.size / (1024 * 1024)).toFixed(2);
                const type = file.type || 'audio/mpeg';
                fileInfo.textContent = `${type} ‚Ä¢ ${size} MB`;
            }
            
            if (uploadPreview) uploadPreview.classList.add('active');
            
            // Store file for upload
            selectedFile = file;
        }
        
        // Upload file - CH·ªà CHO ADMIN
        async function uploadFile() {
            // Ki·ªÉm tra quy·ªÅn admin
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            if (!user || user.type !== 'admin') {
                showNotification('‚ùå Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn upload b√†i h√°t!', 'error');
                return;
            }
            
            const file = selectedFile;
            if (!file) {
                showNotification('Vui l√≤ng ch·ªçn file tr∆∞·ªõc khi upload', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.innerHTML;
            
            // Show loading
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang upload...';
            uploadBtn.disabled = true;
            
            try {
                // Check if uploader is available
                if (!window.FileUploaderEnhanced) {
                    throw new Error('Upload system not available');
                }
                
                const uploader = new FileUploaderEnhanced();
                const result = await uploader.uploadFileToLocalStorage(file);
                
                if (result.success) {
                    showNotification(`‚úÖ Upload th√†nh c√¥ng: ${file.name} (${result.fileSize})`, 'success');
                    
                    // Get metadata
                    const metadata = await uploader.getAudioMetadata(file);
                    
                    // Add to music library
                    const songs = window.getMusicLibrary ? window.getMusicLibrary() : [];
                    const newId = songs.length > 0 ? Math.max(...songs.map(s => s.id)) + 1 : 1;
                    
                    const newSong = {
                        id: newId,
                        title: uploader.extractTitleFromFileName(file.name),
                        artist: 'Upload t·ª´ Admin',
                        duration: metadata.duration,
                        genre: 'EDM',
                        bpm: '128 BPM',
                        price: 0, // M·∫∑c ƒë·ªãnh mi·ªÖn ph√≠
                        type: 'free',
                        thumbnail: 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f',
                        audioUrl: result.dataUrl,
                        description: `B√†i h√°t ƒë∆∞·ª£c upload b·ªüi Admin ${user.name}`,
                        fileSize: result.fileSize,
                        uploadedBy: user.username,
                        uploadedAt: new Date().toISOString()
                    };
                    
                    songs.push(newSong);
                    localStorage.setItem('vgmedia_music_library', JSON.stringify(songs));
                    
                    // Reset form
                    document.getElementById('uploadPreview').classList.remove('active');
                    document.getElementById('fileInput').value = '';
                    selectedFile = null;
                    
                    // Reload library
                    loadMusicLibrary();
                    updateLibraryStats();
                    
                } else {
                    throw new Error('Upload failed');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                showNotification(`‚ùå L·ªói upload: ${error.message}`, 'error');
            } finally {
                // Reset button
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }
        }
        
        // Update library stats
        function updateLibraryStats() {
            const songs = window.getMusicLibrary ? window.getMusicLibrary() : [];
            
            const totalSongs = songs.length;
            const freeSongs = songs.filter(s => s.type === 'free').length;
            const premiumSongs = songs.filter(s => s.type === 'premium').length;
            
            // Calculate total duration
            let totalSeconds = 0;
            songs.forEach(song => {
                const duration = song.duration || '0:00';
                const parts = duration.split(':').map(Number);
                if (parts.length === 3) {
                    totalSeconds += parts[0] * 3600 + parts[1] * 60 + parts[2];
                } else if (parts.length === 2) {
                    totalSeconds += parts[0] * 60 + parts[1];
                }
            });
            
            const totalHours = (totalSeconds / 3600).toFixed(1);
            
            // Update UI
            document.getElementById('totalSongs').textContent = totalSongs;
            document.getElementById('freeSongs').textContent = freeSongs;
            document.getElementById('premiumSongs').textContent = premiumSongs;
            document.getElementById('totalDuration').textContent = totalHours + ' gi·ªù';
        }
        
        // Filter songs by genre
        function filterSongsByGenre(genre) {
            const songs = window.getMusicLibrary ? window.getMusicLibrary() : [];
            const songsList = document.getElementById('songsList');
            
            if (!songsList) return;
            
            let filteredSongs = songs;
            if (genre !== 'all') {
                filteredSongs = songs.filter(song => 
                    song.genre && song.genre.toLowerCase().includes(genre.toLowerCase())
                );
            }
            
            renderFilteredSongs(filteredSongs);
        }
        
        // Filter songs by type
        function filterSongsByType(type) {
            const songs = window.getMusicLibrary ? window.getMusicLibrary() : [];
            const songsList = document.getElementById('songsList');
            
            if (!songsList) return;
            
            let filteredSongs = songs;
            if (type !== 'all') {
                filteredSongs = songs.filter(song => song.type === type);
            }
            
            renderFilteredSongs(filteredSongs);
        }
        
        // Render filtered songs
        function renderFilteredSongs(songs) {
            const songsList = document.getElementById('songsList');
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            
            if (songs.length === 0) {
                songsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8A8A8A; grid-column: 1 / -1;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h4>Kh√¥ng t√¨m th·∫•y b√†i h√°t</h4>
                        <p>Th·ª≠ b·ªô l·ªçc kh√°c ho·∫∑c th√™m b√†i h√°t m·ªõi</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            songs.forEach(song => {
                const canPlay = song.type === 'free' || 
                               (user && (user.isPremium || 
                               (user.purchasedSongs && user.purchasedSongs.includes(song.id))));
                
                const priceDisplay = song.type === 'free' ? 
                    '<span style="color: #4CAF50;"><i class="fas fa-unlock"></i> Mi·ªÖn ph√≠</span>' :
                    `<span style="color: #FF6584;">${song.price ? song.price.toLocaleString('vi-VN') + 'ƒë' : '199,000ƒë'}</span>`;
                
                html += `
                    <div class="song-item" data-id="${song.id}" onclick="playSelectedSong(${song.id})">
                        <img src="${song.thumbnail || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f'}" 
                             alt="${song.title}" 
                             class="song-item-img">
                        <div class="song-item-info">
                            <div class="song-item-title">
                                ${song.title}
                                ${!canPlay ? '<span style="margin-left: 8px; font-size: 12px; color: #FF6584;"><i class="fas fa-lock"></i></span>' : ''}
                            </div>
                            <div class="song-item-artist">${song.artist}</div>
                            <div class="song-item-meta">
                                <span><i class="fas fa-clock"></i> ${song.duration}</span>
                                <span><i class="fas fa-tag"></i> ${song.genre || 'EDM'}</span>
                                <span><i class="fas fa-fire"></i> ${song.bpm || '128 BPM'}</span>
                            </div>
                        </div>
                        <div class="song-item-price ${song.type === 'free' ? 'free' : ''}">
                            ${priceDisplay}
                        </div>
                    </div>
                `;
            });
            
            songsList.innerHTML = html;
        }
        
        // Handle song ended
        function handleSongEnded() {
            if (repeatMode === 'one') {
                // Repeat one song
                const audioPlayer = document.getElementById('audioPlayer');
                if (audioPlayer) {
                    audioPlayer.currentTime = 0;
                    audioPlayer.play();
                }
            } else if (repeatMode === 'all') {
                // Play next song
                playNextSong();
            }
            // If repeatMode is 'off', do nothing
        }
        
        // Show purchase modal
        function showPurchaseModal(song) {
            const price = song.price ? song.price.toLocaleString('vi-VN') + 'ƒë' : '199,000ƒë';
            
            const modalHtml = `
                <div id="purchaseModal" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.9); display: flex; justify-content: center; 
                    align-items: center; z-index: 9999;">
                    <div style="background: #1E1E1E; padding: 30px; border-radius: 20px; 
                         max-width: 500px; width: 90%; border: 2px solid #6C63FF; box-shadow: 0 0 50px rgba(108, 99, 255, 0.5);">
                        <h2 style="color: #6C63FF; margin-bottom: 20px;">
                            <i class="fas fa-crown"></i> Mua b√†i h√°t Premium
                        </h2>
                        <div style="background: rgba(108, 99, 255, 0.1); padding: 20px; 
                             border-radius: 10px; margin-bottom: 25px;">
                            <h3 style="margin-top: 0; color: white;">${song.title}</h3>
                            <p style="color: #B0B0B0; margin-bottom: 15px;">${song.artist} ‚Ä¢ ${song.duration}</p>
                            <div style="display: flex; justify-content: space-between; 
                                 align-items: center; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: #8A8A8A;">Gi√°:</span>
                                <span style="font-size: 24px; font-weight: bold; color: #FF6584;">
                                    ${price}
                                </span>
                            </div>
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                            <h4 style="color: #4CAF50; margin-top: 0;">
                                <i class="fas fa-lightbulb"></i> M·∫πo ti·∫øt ki·ªám
                            </h4>
                            <p style="color: #B0B0B0; font-size: 14px; margin: 5px 0;">
                                <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                                N√¢ng c·∫•p Premium ƒë·ªÉ nghe t·∫•t c·∫£ b√†i h√°t kh√¥ng gi·ªõi h·∫°n
                            </p>
                            <p style="color: #B0B0B0; font-size: 14px;">
                                <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                                Ch·ªâ 499,000ƒë/th√°ng - Ti·∫øt ki·ªám h∆°n mua l·∫ª
                            </p>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <button onclick="document.getElementById('purchaseModal').remove()" style="
                                flex: 1; padding: 15px; background: transparent; border: 2px solid #8A8A8A; 
                                color: #B0B0B0; border-radius: 10px; cursor: pointer; font-weight: 600;
                                transition: all 0.3s;" onmouseover="this.style.borderColor='#FF6584'; this.style.color='#FF6584'" 
                                onmouseout="this.style.borderColor='#8A8A8A'; this.style.color='#B0B0B0'">
                                ƒê·ªÉ sau
                            </button>
                            <button onclick="buySong(${song.id})" style="
                                flex: 2; padding: 15px; background: linear-gradient(135deg, #6C63FF, #FF6584); 
                                border: none; color: white; border-radius: 10px; cursor: pointer; font-weight: 600;
                                transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(108, 99, 255, 0.3)'"
                                onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                                <i class="fas fa-shopping-cart"></i> Mua ngay
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Buy song function
        window.buySong = function(songId) {
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            if (!user) {
                showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua b√†i h√°t', 'error');
                document.getElementById('purchaseModal')?.remove();
                return;
            }
            
            if (user.isPremium) {
                showNotification('üéâ B·∫°n ƒë√£ l√† Premium member! C√≥ th·ªÉ nghe v√† t·∫£i t·∫•t c·∫£ b√†i h√°t.', 'success');
                document.getElementById('purchaseModal')?.remove();
                return;
            }
            
            // G·ªçi h√†m purchase t·ª´ auth-fixed.js
            if (window.purchaseSong) {
                const result = window.purchaseSong(songId);
                if (result && result.success) {
                    showNotification('üéâ Mua b√†i h√°t th√†nh c√¥ng!', 'success');
                    document.getElementById('purchaseModal')?.remove();
                    loadMusicLibrary();
                    loadSong(songId);
                } else {
                    showNotification('‚ùå C√≥ l·ªói x·∫£y ra khi mua b√†i h√°t', 'error');
                }
            } else {
                // Fallback
                const songs = window.getMusicLibrary ? window.getMusicLibrary() : [];
                const song = songs.find(s => s.id === songId);
                
                if (song) {
                    showNotification(`‚úÖ ƒê√£ mua b√†i h√°t "${song.title}"!`, 'success');
                    document.getElementById('purchaseModal')?.remove();
                    loadMusicLibrary();
                    loadSong(songId);
                }
            }
        };
        
        // Show user info
        function showUserInfo(user) {
            const modalHtml = `
                <div id="userInfoModal" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.9); display: flex; justify-content: center; 
                    align-items: center; z-index: 9999;">
                    <div style="background: #1E1E1E; padding: 30px; border-radius: 20px; 
                         max-width: 400px; width: 90%; border: 2px solid #6C63FF;">
                        <h2 style="color: #6C63FF; margin-bottom: 20px;">
                            <i class="fas fa-user-circle"></i> Th√¥ng tin t√†i kho·∫£n
                        </h2>
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #6C63FF, #FF6584); 
                                     border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    ${user.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 style="margin: 0; color: white;">${user.name}</h3>
                                    <p style="color: #8A8A8A; margin: 5px 0;">${user.email || 'Ch∆∞a c√≥ email'}</p>
                                    <span style="background: ${user.type === 'admin' ? '#6C63FF' : user.isPremium ? '#FFD700' : '#4CAF50'}; 
                                          color: ${user.type === 'admin' || user.isPremium ? '#000' : 'white'}; 
                                          padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                        ${user.type === 'admin' ? 'Admin' : user.isPremium ? 'Premium' : 'User'}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="background: rgba(108, 99, 255, 0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                                <p style="color: #B0B0B0; margin: 5px 0;">
                                    <i class="fas fa-calendar"></i> Tham gia: ${new Date(user.createdAt || Date.now()).toLocaleDateString('vi-VN')}
                                </p>
                                <p style="color: #B0B0B0; margin: 5px 0;">
                                    <i class="fas fa-music"></i> B√†i h√°t ƒë√£ mua: ${user.purchasedSongs ? user.purchasedSongs.length : 0}
                                </p>
                            </div>
                        </div>
                        <button onclick="document.getElementById('userInfoModal').remove()" style="
                            width: 100%; padding: 12px; background: #6C63FF; border: none; 
                            color: white; border-radius: 10px; cursor: pointer; font-weight: 600;">
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(el => el.remove());
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed; bottom: 20px; right: 20px; 
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#FF6584' : '#6C63FF'}; 
                color: white; padding: 15px 25px; border-radius: 10px; 
                box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; 
                animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px;
                max-width: 400px;
            `;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            notification.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            
            // Auto remove
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
