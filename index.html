<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VGMEDIA - N·ªÅn t·∫£ng nh·∫°c DJ Remix</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <span class="logo-icon">üéµ</span>
                    <h1 class="logo-text">VG<span class="logo-highlight">MEDIA</span></h1>
                </div>
                
                <div class="nav-links">
                    <a href="#player" class="nav-link active">Trang ch·ªß</a>
                    <a href="#library" class="nav-link">Th∆∞ vi·ªán</a>
                    <a href="#trending" class="nav-link">Trending</a>
                    <a href="./admin.html" class="nav-link" id="adminLink" style="display:none;">Qu·∫£n l√Ω</a>
                </div>
                
                <div class="nav-actions">
                    <div class="user-menu" id="userMenu" style="display:none;">
                        <span id="userName">User</span>
                        <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                    <button class="btn-login" id="loginBtn">ƒêƒÉng nh·∫≠p</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div id="contentArea">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load ƒë·ªông -->
                <div style="text-align:center; padding:100px 20px;">
                    <h1 id="statusMessage">üéµ ƒêang ki·ªÉm tra ƒëƒÉng nh·∫≠p...</h1>
                    <p id="statusDetail">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
                    <div id="actionButtons" style="margin-top:30px;"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 VGMEDIA</p>
            </div>
        </div>
    </footer>

    <script>
        // FIXED: Ki·ªÉm tra login m·∫°nh m·∫Ω
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Checking login status...');
            
            // Ki·ªÉm tra nhi·ªÅu ngu·ªìn
            checkLoginFromMultipleSources();
        });
        
        function checkLoginFromMultipleSources() {
            const statusMessage = document.getElementById('statusMessage');
            const statusDetail = document.getElementById('statusDetail');
            const actionButtons = document.getElementById('actionButtons');
            
            // Ngu·ªìn 1: localStorage
            let authData = localStorage.getItem('vgmedia_auth');
            
            // Ngu·ªìn 2: Ki·ªÉm tra URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const loginParam = urlParams.get('login');
            
            // Ngu·ªìn 3: sessionStorage
            const sessionLogin = sessionStorage.getItem('vgmedia_login_time');
            
            console.log('Auth sources:', {
                localStorage: authData ? 'Exists' : 'None',
                urlParam: loginParam,
                sessionStorage: sessionLogin
            });
            
            // ∆Øu ti√™n: N·∫øu c√≥ URL parameter, force s·ª≠ d·ª•ng localStorage
            if (loginParam || sessionLogin) {
                console.log('Login detected from URL/session');
                
                if (!authData) {
                    // Th·ª≠ l·∫•y t·ª´ default users
                    try {
                        const users = JSON.parse(localStorage.getItem('vgmedia_users') || '[]');
                        const defaultUser = users.find(u => u.username === 'user');
                        if (defaultUser) {
                            const { password, ...userWithoutPass } = defaultUser;
                            localStorage.setItem('vgmedia_auth', JSON.stringify(userWithoutPass));
                            authData = localStorage.getItem('vgmedia_auth');
                            console.log('Auto-logged with default user');
                        }
                    } catch (e) {
                        console.error('Auto-login failed:', e);
                    }
                }
            }
            
            if (authData) {
                try {
                    const user = JSON.parse(authData);
                    console.log('User found:', user.name);
                    
                    // C·∫¨P NH·∫¨T UI
                    statusMessage.innerHTML = `üéâ Ch√†o m·ª´ng tr·ªü l·∫°i, <span style="color:#6C63FF">${user.name}</span>!`;
                    statusDetail.textContent = 'ƒêang t·∫£i th∆∞ vi·ªán nh·∫°c...';
                    
                    // C·∫≠p nh·∫≠t header
                    document.getElementById('userMenu').style.display = 'flex';
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('loginBtn').style.display = 'none';
                    
                    if (user.type === 'admin') {
                        document.getElementById('adminLink').style.display = 'block';
                    }
                    
                    // Hi·ªÉn th·ªã n√∫t h√†nh ƒë·ªông
                    actionButtons.innerHTML = `
                        <button class="btn-action btn-play" onclick="loadMusicLibrary()" style="margin:10px;">
                            <i class="fas fa-music"></i> Xem th∆∞ vi·ªán nh·∫°c
                        </button>
                        <button class="btn-action btn-like" onclick="goToAdmin()" style="margin:10px;">
                            <i class="fas fa-cog"></i> Trang qu·∫£n l√Ω
                        </button>
                    `;
                    
                    // T·ª± ƒë·ªông load th∆∞ vi·ªán sau 1 gi√¢y
                    setTimeout(() => {
                        loadMusicLibrary();
                    }, 1000);
                    
                } catch (e) {
                    console.error('Error parsing auth:', e);
                    showLoginPrompt();
                }
            } else {
                console.log('No user logged in');
                showLoginPrompt();
            }
        }
        
        function showLoginPrompt() {
            const statusMessage = document.getElementById('statusMessage');
            const statusDetail = document.getElementById('statusDetail');
            const actionButtons = document.getElementById('actionButtons');
            
            statusMessage.innerHTML = 'üéµ Ch√†o m·ª´ng ƒë·∫øn VGMEDIA';
            statusDetail.innerHTML = 'ƒêƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p th∆∞ vi·ªán nh·∫°c ch·∫•t l∆∞·ª£ng cao';
            
            actionButtons.innerHTML = `
                <button class="btn-action btn-play" onclick="goToLogin()" style="margin:10px;">
                    <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p ngay
                </button>
                <button class="btn-action btn-like" onclick="goToAdmin()" style="margin:10px;">
                    <i class="fas fa-cog"></i> Trang qu·∫£n l√Ω (Admin)
                </button>
                <div style="margin-top:30px; background:rgba(108,99,255,0.1); padding:20px; border-radius:10px;">
                    <h4><i class="fas fa-key"></i> T√†i kho·∫£n demo:</h4>
                    <p><strong>Admin:</strong> admin / admin123</p>
                    <p><strong>User:</strong> user / user123</p>
                    <p><strong>Premium:</strong> premium / premium123</p>
                </div>
            `;
            
            // Hi·ªÉn th·ªã login button
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('userMenu').style.display = 'none';
        }
        
        function loadMusicLibrary() {
            const contentArea = document.getElementById('contentArea');
            
            // T·∫°o player v√† library
            contentArea.innerHTML = `
                <div class="player-container">
                    <div class="player-card">
                        <h2><i class="fas fa-headphones"></i> Player</h2>
                        <p>ƒêang t·∫£i player...</p>
                    </div>
                    
                    <div class="music-library">
                        <div class="library-header">
                            <h3><i class="fas fa-music"></i> Th∆∞ vi·ªán nh·∫°c</h3>
                        </div>
                        <div class="songs-list" id="songsList">
                            <div class="loading">ƒêang t·∫£i b√†i h√°t...</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load songs t·ª´ music-data.js
            loadSongs();
        }
        
        function loadSongs() {
            try {
                const songs = JSON.parse(localStorage.getItem('vgmedia_music_library') || '[]');
                const songsList = document.getElementById('songsList');
                
                if (songs.length === 0) {
                    songsList.innerHTML = `
                        <div style="text-align:center; padding:40px; color:#8A8A8A;">
                            <i class="fas fa-music" style="font-size:3rem; opacity:0.3;"></i>
                            <p>Ch∆∞a c√≥ b√†i h√°t n√†o</p>
                            <button onclick="goToAdmin()" class="btn-action" style="margin-top:20px;">
                                <i class="fas fa-plus"></i> Th√™m b√†i h√°t m·ªõi
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                songs.forEach(song => {
                    html += `
                        <div class="song-item" onclick="playSong(${song.id})">
                            <img src="${song.thumbnail || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f'}" 
                                 class="song-item-img">
                            <div class="song-item-info">
                                <div class="song-item-title">${song.title}</div>
                                <div class="song-item-artist">${song.artist}</div>
                                <div class="song-item-meta">
                                    <span>${song.duration || '3:30'}</span>
                                    <span>${song.genre || 'EDM'}</span>
                                </div>
                            </div>
                            <div class="song-item-price ${song.type === 'free' ? 'free' : 'premium'}">
                                ${song.type === 'free' ? 'Mi·ªÖn ph√≠' : song.price ? song.price.toLocaleString('vi-VN') + 'ƒë' : '199,000ƒë'}
                            </div>
                        </div>
                    `;
                });
                
                songsList.innerHTML = html;
            } catch (e) {
                console.error('Error loading songs:', e);
            }
        }
        
        function playSong(songId) {
            alert('T√≠nh nƒÉng ph√°t nh·∫°c ƒëang ƒë∆∞·ª£c k√≠ch ho·∫°t. Song ID: ' + songId);
        }
        
        function goToLogin() {
            window.location.href = './login.html';
        }
        
        function goToAdmin() {
            window.location.href = './admin.html';
        }
        
        // Logout function
        document.getElementById('logoutBtn')?.addEventListener('click', function() {
            if (confirm('ƒêƒÉng xu·∫•t?')) {
                localStorage.removeItem('vgmedia_auth');
                sessionStorage.removeItem('vgmedia_login_time');
                location.reload();
            }
        });
        
        // Login button
        document.getElementById('loginBtn').addEventListener('click', goToLogin);
    </script>
</body>
</html>
